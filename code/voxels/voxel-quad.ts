// ********************************************************************************************************************
import { DataTextureLoader, Mesh, MeshStandardMaterial, Scene } from 'three/src/Three';
// ********************************************************************************************************************
import { GeometryBuilder } from '../geometry/geometry-builder';
import { GeometryData } from '../geometry/geometry-data';
// ********************************************************************************************************************
import { Bounds3 } from '../types/bounds3';
// ********************************************************************************************************************
import { Vector3 } from '../types/vector3';
// ********************************************************************************************************************
export class VoxelQuad extends Bounds3 {

    // ****************************************************************************************************************
    // dirty - whether dirty
    // ****************************************************************************************************************
    private dirty: boolean = false;

    // ****************************************************************************************************************
    // mesh - the mesh
    // ****************************************************************************************************************
    private mesh: Mesh | null = null;

    // ****************************************************************************************************************
    // voxels - the voxels
    // ****************************************************************************************************************
    private voxels: boolean[][][] = [];

    // ****************************************************************************************************************
    // constructor
    // ****************************************************************************************************************
    constructor(private readonly scene: Scene, public readonly location: Vector3, min: Vector3, max: Vector3) { super(min, max); }

    // ****************************************************************************************************************
    // function:    createArray
    // ****************************************************************************************************************
    // parameters:  n/a
    // ****************************************************************************************************************
    // returns:     n/a
    // ****************************************************************************************************************
    private createArray(): void {

        if (this.voxels.length === 0) {

            this.voxels.length = this.sizeX;

            // *********************************************************************************************************
            // create axis 1
            // *********************************************************************************************************

            for (var x = 0; x < this.voxels.length; x++) {

                this.voxels[x] = [];

                this.voxels[x].length = this.sizeY;

                // *****************************************************************************************************
                // create axis 2
                // *****************************************************************************************************

                for (var y = 0; y < this.voxels.length; y++) {

                    this.voxels[x][y] = [];

                    this.voxels[x][y].length = this.sizeZ;
                }
            }
        }
    }

    // ****************************************************************************************************************
    // function:    createGeometry
    // ****************************************************************************************************************
    // parameters:  builder - the builder
    // ****************************************************************************************************************
    // returns:     n/a
    // ****************************************************************************************************************
    public createGeometry(builder: GeometryBuilder): void {

        if (this.voxels.length) {

            for (var x = 0; x < this.sizeX; x++) {

                for (var y = 0; y < this.sizeY; y++) {

                    for (var z = 0; z < this.sizeZ; z++) {

                        if (this.voxels[x][y][z]) {

                            // ****************************************************************************************
                            // world
                            // ****************************************************************************************

                            const wx = this.min.x + x;

                            const wy = this.min.y + y;

                            const wz = this.min.z + z;

                            // ****************************************************************************************
                            // left
                            // ****************************************************************************************

                            if (x === 0 || !this.voxels[x - 1][y][z]) {

                                const dataLub = new GeometryData(new Vector3(wx - 0.5, wy + 0.5, wz - 0.5));

                                const dataLuf = new GeometryData(new Vector3(wx - 0.5, wy + 0.5, wz + 0.5));

                                const dataLdb = new GeometryData(new Vector3(wx - 0.5, wy - 0.5, wz - 0.5));

                                const dataLdf = new GeometryData(new Vector3(wx - 0.5, wy - 0.5, wz + 0.5));

                                builder.addQuad(dataLub, dataLuf, dataLdb, dataLdf);
                            }

                            // ****************************************************************************************
                            // right
                            // ****************************************************************************************

                            if (x === this.sizeX - 1 || !this.voxels[x + 1][y][z]) {

                                const dataRuf = new GeometryData(new Vector3(wx + 0.5, wy + 0.5, wz + 0.5));

                                const dataRub = new GeometryData(new Vector3(wx + 0.5, wy + 0.5, wz - 0.5));

                                const dataRdf = new GeometryData(new Vector3(wx + 0.5, wy - 0.5, wz + 0.5));

                                const dataRdb = new GeometryData(new Vector3(wx + 0.5, wy - 0.5, wz - 0.5));

                                builder.addQuad(dataRuf, dataRub, dataRdf, dataRdb);
                            }

                            // ****************************************************************************************
                            // up
                            // ****************************************************************************************

                            if (y === this.sizeY - 1 || !this.voxels[x][y + 1][z]) {

                                const dataLub = new GeometryData(new Vector3(wx - 0.5, wy + 0.5, wz - 0.5));

                                const dataRub = new GeometryData(new Vector3(wx + 0.5, wy + 0.5, wz - 0.5));

                                const dataLuf = new GeometryData(new Vector3(wx - 0.5, wy + 0.5, wz + 0.5));

                                const dataRuf = new GeometryData(new Vector3(wx + 0.5, wy + 0.5, wz + 0.5));

                                builder.addQuad(dataLub, dataRub, dataLuf, dataRuf);
                            }

                            // ****************************************************************************************
                            // down
                            // ****************************************************************************************

                            if (y === 0 || !this.voxels[x][y - 1][z]) {

                                const dataRdb = new GeometryData(new Vector3(wx + 0.5, wy - 0.5, wz - 0.5));

                                const dataLdb = new GeometryData(new Vector3(wx - 0.5, wy - 0.5, wz - 0.5));

                                const dataRdf = new GeometryData(new Vector3(wx + 0.5, wy - 0.5, wz + 0.5));

                                const dataLdf = new GeometryData(new Vector3(wx - 0.5, wy - 0.5, wz + 0.5));

                                builder.addQuad(dataRdb, dataLdb, dataRdf, dataLdf);
                            }

                            // ****************************************************************************************
                            // front
                            // ****************************************************************************************

                            if (z === this.sizeZ - 1 || !this.voxels[x][y][z + 1]) {

                                const dataLuf = new GeometryData(new Vector3(wx - 0.5, wy + 0.5, wz + 0.5));

                                const dataRuf = new GeometryData(new Vector3(wx + 0.5, wy + 0.5, wz + 0.5));

                                const dataLdf = new GeometryData(new Vector3(wx - 0.5, wy - 0.5, wz + 0.5));

                                const dataRdf = new GeometryData(new Vector3(wx + 0.5, wy - 0.5, wz + 0.5));

                                builder.addQuad(dataLuf, dataRuf, dataLdf, dataRdf);
                            }

                            // ****************************************************************************************
                            // back
                            // ****************************************************************************************

                            if (z === 0 || !this.voxels[x][y][z - 1]) {

                                const dataRub = new GeometryData(new Vector3(wx + 0.5, wy + 0.5, wz - 0.5));

                                const dataLub = new GeometryData(new Vector3(wx - 0.5, wy + 0.5, wz - 0.5));

                                const dataRdb = new GeometryData(new Vector3(wx + 0.5, wy - 0.5, wz - 0.5));

                                const dataLdb = new GeometryData(new Vector3(wx - 0.5, wy - 0.5, wz - 0.5));

                                builder.addQuad(dataRub, dataLub, dataRdb, dataLdb);
                            }
                        }
                    }
                }
            }
        }
    }

    // ****************************************************************************************************************
    // function:    getVoxel
    // ****************************************************************************************************************
    // parameters:  x - the x
    // ****************************************************************************************************************
    //              y - the y
    // ****************************************************************************************************************
    //              z - the z
    // ****************************************************************************************************************
    // returns:     the voxel 
    // ****************************************************************************************************************
    public getVoxel(x: number, y: number, z: number): boolean {

        x -= this.min.x;

        y -= this.min.y;

        z -= this.min.z;

        if (x >= 0 && x < this.sizeX && y >= 0 && y < this.sizeY && z >= 0 && z < this.sizeZ) {

            return this.getVoxelInternal(x, y, z);
        }
        return false;
    }

    // ****************************************************************************************************************
    // function:    getVoxelInternal
    // ****************************************************************************************************************
    // parameters:  x - the x
    // ****************************************************************************************************************
    //              y - the y
    // ****************************************************************************************************************
    //              z - the z
    // ****************************************************************************************************************
    // returns:     the voxel
    // ****************************************************************************************************************
    private getVoxelInternal(x: number, y: number, z: number): boolean {

        if (this.voxels.length) {

            return this.voxels[x][y][z];
        }
        return false;
    }

    // ****************************************************************************************************************
    // function:    setVoxel
    // ****************************************************************************************************************
    // parameters:  x - the x
    // ****************************************************************************************************************
    //              y - the y
    // ****************************************************************************************************************
    //              z - the z
    // ****************************************************************************************************************
    //              voxel - the voxel
    // ****************************************************************************************************************
    // returns:     n/a
    // ****************************************************************************************************************
    public setVoxel(x: number, y: number, z: number, voxel: boolean): void {

        x -= this.min.x;

        y -= this.min.y;

        z -= this.min.z;

        if (x >= 0 && x < this.sizeX && y >= 0 && y < this.sizeY && z >= 0 && z < this.sizeZ) {

            this.setVoxelInternal(x, y, z, voxel);
        }
    }

    // ****************************************************************************************************************
    // function:    setVoxelInternal
    // ****************************************************************************************************************
    // parameters:  x - the x
    // ****************************************************************************************************************
    //              y - the y
    // ****************************************************************************************************************
    //              z - the z
    // ****************************************************************************************************************
    //              voxel - the voxel
    // ****************************************************************************************************************
    // returns:     n/a
    // ****************************************************************************************************************
    private setVoxelInternal(x: number, y: number, z: number, voxel: boolean): void {

        this.createArray();

        this.voxels[x][y][z] = voxel;

        this.dirty = true;
    }

    // ****************************************************************************************************************
    // function:    setVoxels
    // ****************************************************************************************************************
    // parameters:  voxel - the voxel
    // ****************************************************************************************************************
    // returns:     n/a
    // ****************************************************************************************************************
    public setVoxels(voxel: boolean): void {

        this.createArray();

        for (var x = 0; x < this.sizeX; x++) {

            for (var y = 0; y < this.sizeY; y++) {

                this.voxels[x][y].fill(voxel);
            }
        }
    }

    // ****************************************************************************************************************
    // function:    update
    // ****************************************************************************************************************
    // parameters:  n/a
    // ****************************************************************************************************************
    // returns:     n/a
    // ****************************************************************************************************************
    public update(): void {

        if (this.dirty && this.voxels.length) {

            this.dirty = false;

            if (this.mesh) this.scene.remove(this.mesh);

            const builder = new GeometryBuilder();

            this.createGeometry(builder);

            if (builder.valid) {

                const geometry = builder.generate();

                const material = new MeshStandardMaterial({ color: '#f0fff0', roughness: 1.0, wireframe: false });

                geometry.computeVertexNormals();

                this.mesh = new Mesh(geometry, material);

                this.scene.add(this.mesh);
            }
        }
    }
}
